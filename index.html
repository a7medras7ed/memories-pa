<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>صفحة الذكريات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Arial', sans-serif;
      direction: rtl;
      background: linear-gradient(to bottom, #f0f2f5, #dfe6ed);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .memory-form {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
      display: none;
    }
    .memory-form input, .memory-form textarea, .memory-form select {
      display: block;
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }
    #toggleForm {
      background: #007bff;
      color: white;
      padding: 10px;
      border: none;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .memory-card {
      background: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .memory-card img, .memory-card video {
      max-width: 100%;
      margin-bottom: 10px;
    }
    .memory-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .memory-header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .memory-actions {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    .memory-actions i {
      cursor: pointer;
      color: #555;
    }
    .comments {
      margin-top: 10px;
    }
    .comment {
      background: #f0f0f0;
      padding: 5px 10px;
      border-radius: 5px;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>📸 صفحة الذكريات</h2>

    <!-- زر إظهار النموذج -->
    <button id="toggleForm">➕ إضافة ذكرى</button>

    <!-- نموذج إعداد المستخدم (مرة واحدة فقط) -->
    <div class="memory-form" id="userSetupForm">
      <h4>تسجيل بيانات المستخدم لأول مرة</h4>
      <input type="text" id="setupUsername" placeholder="اسم المستخدم">
      <input type="file" id="setupPhoto" accept="image/*">
      <button onclick="saveUser()">حفظ بياناتي</button>
    </div>

    <!-- نموذج إضافة ذكرى -->
    <div class="memory-form" id="memoryForm">
      <textarea id="memoryText" placeholder="ما الذي تفكر به؟"></textarea>
      <input type="file" id="memoryMedia" accept="image/*,video/*" />
      <select id="mood">
        <option value="">اختر حالتك</option>
        <option value="😊 يشعر بالسعادة">😊 يشعر بالسعادة</option>
        <option value="😢 يشعر بالحزن">😢 يشعر بالحزن</option>
        <option value="😡 يشعر بالغضب">😡 يشعر بالغضب</option>
        <option value="❤️ يشعر بالحب">❤️ يشعر بالحب</option>
      </select>
      <button onclick="submitMemory()">نشر</button>
    </div>

    <!-- حاوية الذكريات -->
    <div id="memoriesContainer"></div>
  </div>

  <script>
    let currentUser = {
      username: "",
      userPhoto: "",
      userId: ""
    };

    window.onload = () => {
      const savedUser = localStorage.getItem("memoryUser");
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById("userSetupForm").style.display = "none";
        document.getElementById("memoryForm").style.display = "none";
      } else {
        document.getElementById("userSetupForm").style.display = "block";
      }
    };

    document.getElementById("toggleForm").onclick = () => {
      const form = document.getElementById("memoryForm");
      if (!currentUser.username) {
        alert("سجل بيانات المستخدم أولًا.");
        return;
      }
      form.style.display = form.style.display === "block" ? "none" : "block";
    };

    function saveUser() {
      const username = document.getElementById("setupUsername").value.trim();
      const photoFile = document.getElementById("setupPhoto").files[0];

      if (!username || !photoFile) {
        alert("الرجاء إدخال الاسم والصورة.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function () {
        const userPhoto = reader.result;
        const userId = Date.now().toString(36);
        currentUser = { username, userPhoto, userId };
        localStorage.setItem("memoryUser", JSON.stringify(currentUser));
        document.getElementById("userSetupForm").style.display = "none";
        alert("تم حفظ بيانات المستخدم بنجاح.");
      };
      reader.readAsDataURL(photoFile);
    }

    function submitMemory() {
      const memoryText = document.getElementById("memoryText").value;
      const mood = document.getElementById("mood").value;
      const memoryMedia = document.getElementById("memoryMedia").files[0];

      const reader = new FileReader();

      if (memoryMedia) {
        reader.onload = function () {
          const mediaURL = reader.result;
          const mediaType = memoryMedia.type.startsWith("video") ? "video" : "image";
          createMemory(currentUser, memoryText, mood, mediaURL, mediaType);
        };
        reader.readAsDataURL(memoryMedia);
      } else {
        createMemory(currentUser, memoryText, mood);
      }

      document.getElementById("memoryText").value = "";
      document.getElementById("mood").value = "";
      document.getElementById("memoryMedia").value = "";
      document.getElementById("memoryForm").style.display = "none";
    }

    function createMemory(user, text, mood = "", media = "", mediaType = "") {
      const container = document.getElementById("memoriesContainer");
      const card = document.createElement("div");
      card.className = "memory-card";

      const mediaHTML = media ? (mediaType === "video" ? `<video controls src="${media}"></video>` : `<img src="${media}" />`) : "";

      card.innerHTML = `
        <div class="memory-header">
          ${user.userPhoto ? `<img src="${user.userPhoto}" />` : ""}
          <strong>${user.username}</strong> <small>(ID: ${user.userId})</small>
        </div>
        <p>${text}</p>
        ${mood ? `<p>${mood}</p>` : ""}
        ${mediaHTML}
        <div class="memory-actions">
          <i class="fa-regular fa-thumbs-up" onclick="toggleReaction(this)"> إعجاب</i>
          <i class="fa-regular fa-comment" onclick="toggleComments(this)"> تعليق</i>
          <i class="fa-solid fa-share"> مشاركة</i>
        </div>
        <div class="comments" style="display:none;">
          <input type="text" placeholder="اكتب تعليق..." onkeydown="submitComment(event, this)" />
          <div class="comment-list"></div>
        </div>
      `;

      container.prepend(card);
    }

    function toggleReaction(icon) {
      const emojis = ["❤️", "😂", "😢", "😡"];
      const current = icon.innerText.trim();
      const next = emojis[(emojis.indexOf(current) + 1) % emojis.length];
      icon.innerHTML = ` ${next}`;
    }

    function toggleComments(btn) {
      const section = btn.closest(".memory-card").querySelector(".comments");
      section.style.display = section.style.display === "block" ? "none" : "block";
    }

    function submitComment(e, input) {
      if (e.key === "Enter") {
        const text = input.value.trim();
        if (text) {
          const div = document.createElement("div");
          div.className = "comment";
          div.textContent = text;
          input.nextElementSibling.appendChild(div);
          input.value = "";
        }
      }
    }
  </script>
</body>
</html>
